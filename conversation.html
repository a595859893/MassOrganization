<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--全屏显示-->
    <meta name="viewport"
          content="width=375,initial-scale=0.84,user-scalable=0"/>

    <!--引用weui框架做样式-->
    <!--<link rel="stylesheet" href="weui.min.css">-->
    <link rel="stylesheet" href="http://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">
    <link rel="stylesheet" href="conversation.css">
    <!--<script src="jquery.js"></script>-->
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css">
</head>
<body>

<div class="hqfenlei">
    <div class="hqdingduan">
        <span id="conversation" class="hqxuanxiang2 hqxuanxiang1 ciji0 xuanzhong">话圈</span>
        <span id="debunk" class="hqxuanxiang2 ciji0">匿槽</span>
    </div>
    <div id="hqdingduanxinjian" class="hqxinjian" style="display: none">
        <span class="hqjiahao" onclick="hqxinjian('hqxjdh','xinhuaquan')" >+</span>
    </div>
</div>

<div class="hqncym" id="hqym">
    <div class="jrht"><span class="jrhtnr">中山大学是个怎么样的学校</span></div>
    <p class="htwenzi" style="margin: 10px">往期话题</p>
    <div class="wqht">
        <div class="wqhtts">
            <div class="wqhtyidong">
                <ul>
                    <li><span class="wqhtwz">读中大是一种怎样的体验1</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验2</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验3</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验4</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验5</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验6</span></li>
                    <li><span class="wqhtwz">读中大是一种怎样的体验7</span></li>
                </ul>
            </div>
        </div></div>
    <div style="margin: 10px">
        <p class="htwenzi" style="background-color: #f9f9f9;">热门话题
            <i class="fa fa-question-circle-o" style="font-size:24px"></i>
            <span class="fa fa-plus-circle hqjiahao" style="font-size:24px;float: right" onclick="hqxinjian('hqxjht','xinhuati')"></span>
        </p>
    </div>

    <div class="rmht" style="background-color: #f9f9f9;">
        <ul id="conversation_piece">
            <!--JS添加地点-->
        </ul>
    </div>
    <div id="hqxjht" class="hqhtxjdh" style="display: none">
        <textarea id="xinhuati" class="htsrfsk" style="color:#615f62;" placeholder="参与讨论"
                  name="usrname"></textarea>
        <i id="sendMain2" class="fa fa-send-o hphttjwz"></i>
    </div>
</div>


<div class="hqncym" id="ncym" style="display: none">
    <div id="hqxjdh" class="hqxjdh hqzhongyang" style="display: none">
        <div class="hqmzxz">
            <i id="left" class="hqxzajz">&lt;</i>
            <span id="hqniming" class="yuan">A</span>
            <i id="right" class="hqxzajy">&gt;</i>
        </div>
        <textarea id="xinhuaquan" class="hqsr" style="color:#615f62;" placeholder="点击输入属于你的匿槽"
                  name="usrname"></textarea>
        <i id="sendMain" class="fa fa-send-o hptjwz"></i>
    </div>

    <div class="content">
        <ul id="conversation_main" style="list-style:none;">
            <!--JS添加地点-->
        </ul>
    </div>
</div>

<script src="CommonJS.js"></script>
<script>
    var newConversation = false;
    var characterIndex = 65;

    var main = document.getElementById("conversation_main");
    var main_2 = document.getElementById("conversation_piece");
    var top_conversation = document.getElementById("conversation");
    var top_debunk = document.getElementById("debunk");
    document.getElementById('right').onclick = function () {
        characterIndex = characterIndex >= 90 ? 65 : characterIndex + 1;
        document.getElementById('hqniming').innerText = String.fromCharCode(characterIndex);
    };
    document.getElementById('left').onclick = function () {
        characterIndex = characterIndex <= 65 ? 90 : characterIndex - 1;
        document.getElementById('hqniming').innerText = String.fromCharCode(characterIndex);
    };
    document.getElementById('sendMain').onclick = function () {
        document.getElementById("xinhuaquan").disabled = true;
        postMessage({
            serverType: "Send",
            type: "debunk",
            character: document.getElementById('hqniming').innerText,
            content: document.getElementById("xinhuaquan").value,
            UID: -1
        }, "conversation.php", function () {
            init();
            document.getElementById("xinhuaquan").disabled = false;
            document.getElementById("xinhuaquan").value = "";
        });
    };
    document.getElementById('sendMain2').onclick = function () {
        document.getElementById("xinhuati").disabled = true;
        postMessage({
            serverType: "Send",
            type: "conversation",
            character: "",
            content: document.getElementById("xinhuati").value,
            UID: -1
        }, "conversation.php", function () {
            init();
            document.getElementById("xinhuati").disabled = false;
            document.getElementById("xinhuati").value = "";
        });
    };
    top_conversation.onclick = function () {
        init();
        document.getElementById("ncym").style.display = 'none';
        document.getElementById("hqdingduanxinjian").style.display = 'none';
        document.getElementById("hqym").style.display = 'block';
        top_debunk.className = top_debunk.className.replace(" xuanzhong", "");
        top_conversation.className += " xuanzhong";
    };
    top_debunk.onclick = function () {
        init();
        document.getElementById("hqym").style.display = 'none';
        document.getElementById("ncym").style.display = 'block';
        document.getElementById("hqdingduanxinjian").style.display = 'block';
        top_conversation.className = top_conversation.className.replace(" xuanzhong", "");
        top_debunk.className += " xuanzhong";
    };
    init();

    function appendConversation(topic, good, index, uid) {
        var li = document.createElement("li");
        var span_1 = document.createElement("span");
        var span_2 = document.createElement("span");
        var span_3 = document.createElement("span");
        var span_4 = document.createElement("span");
        var span_5 = document.createElement("span");

        li.className = "rmhtxx";
        span_1.className = "rmhtnr";
        span_2.className = "rmhtbh";
        span_3.className = "rmhtnrwz";
        span_4.className = "rmhtdp fa fa-lightbulb-o";
        span_5.className = "rmhtdprd";

        span_2.innerText = index;
        span_3.innerText = topic;
        span_5.innerText = good;

        span_4.style = "font-size: 23px;";
        span_4.onclick = function (e) {
            postMessage({serverType: "Good", topicID: uid}, "conversation.php", function () {
                span_5.innerText = (parseInt(span_5.innerText) + 1);
            });
        };

        span_1.appendChild(span_2);
        span_1.appendChild(span_3);
        li.appendChild(span_1);
        li.appendChild(span_4);
        li.appendChild(span_5);

        return li;
    }

    function appendTopic(uid, character, content, good, review, black) {
        var li = document.createElement("li");
        var span = document.createElement("span");
        var p = document.createElement("p");
        var divWhole = document.createElement("div");
        var div = document.createElement("div");
        var ul = document.createElement("ul");
        var span_1 = document.createElement("span");
        var span_1_text = document.createElement("span");
        var span_2 = document.createElement("span");
        var span_2_text = document.createElement("span");
        var liSend = document.createElement("li");
        var span_send = document.createElement("span");
        var textarea = document.createElement("textarea");
        var icon = document.createElement("i");

        var right = document.createElement("i");
        right.style = "display:inline-block;position:absolute;left:4.5em";
        right.innerText = ">";

        var left = document.createElement("i");
        left.style = "display:inline-block;position:absolute;left:2em";
        left.innerText = "<";

        divWhole.className = black ? "baikuang zhongyang" : "baikuang zhongyang baise";
        span.className = "yuan";

        div.className = "dzpl";
        span_1.className = "hqtb fa fa-thumbs-up";
        span_2.className = "hqtb fa fa-comment";
        span_1_text.className = span_2_text.className = black ? "hqsl" : "hqsl heisez";
        liSend.className = "hqhf zhongyang";
        span_send.className = "hqhfyuan";
        icon.className = "fa fa-send-o hqxjplfs";
        textarea.className = "hqplkuang";

        if (black) {
            span_2.style = span_1.style = 'color: white';
            p.className = "weui-flex__item hqquangao";
        } else {
            p.className = "weui-flex__item hqquangao heisez";
        }

        ul.style.display = "none";
        li.id = "piece " + uid;
        textarea.type = "text";
        textarea.style = "color:#b8a4a4;";
        liSend.style.display = "none";

        p.innerText = content;
        span_1_text.innerText = good + "    ";
        span_2_text.innerText = review.length;
        span.innerText = character;
        span_send.innerText = "A";
        divWhole.onclick = function (e) {
            if (e.target == span_1) {
                postMessage({serverType: "Good", topicID: uid}, "conversation.php", function () {
                    span_1_text.innerText = (parseInt(span_1_text.innerText.replace(" ", "")) + 1) + "    ";
                });
                return;
            }
            if (ul.style.display == "block") {
                ul.style.display = "none"
                liSend.style.display = "none";
            } else {
                var tempLI = ul.getElementsByTagName("li");
                for (var i = 0; i < tempLI.length; i++) {
                    var tempDIV = tempLI[i].getElementsByTagName("div");
                    if (tempDIV.length > 0)
                        tempDIV[0].style.display = "block"
                }
                ul.style.display = "block"
                if (review.length == 0)
                    liSend.style.display = "block";
            }
        };
        div.onclick = function (e) {
            liSend.style.display = "block";
        };
        icon.onclick = function (e) {
            textarea.disabled = true;
            postMessage({
                serverType: "Send",
                character: span_send.innerText,
                content: textarea.value,
                UID: uid
            }, "conversation.php", function () {
                var tempLI = ul.getElementsByTagName("li");
                for (var i = 0; i < tempLI.length; i++) {
                    var tempDIV = tempLI[i].getElementsByTagName("div");
                    if (tempDIV.length > 0) {
                        tempDIV[0].onclick = null;
                        tempLI[i].removeChild(tempDIV[0]);
                    }
                }
                ul.appendChild(appendReview(uid, span_send.innerText, textarea.value, true));
                liSend.style.display = "none";
                textarea.disabled = false;
                textarea.placeholder = "请输入评论";
                textarea.value = "";
            });
        };
        var charIndex = 90;
        right.onclick = function () {
            charIndex = charIndex >= 90 ? 65 : charIndex + 1;
            span_send.innerText = String.fromCharCode(charIndex);
        };
        left.onclick = function () {
            charIndex = charIndex <= 65 ? 90 : charIndex - 1;
            span_send.innerText = String.fromCharCode(charIndex);
        };

        if (review.length > 0) {
            for (var i = 0; i < review.length; i++)
                ul.appendChild(appendReview(uid, review[i].word, review[i].content, i == review.length - 1));
            textarea.placeholder = "请输入评论";
        } else {
            textarea.placeholder = "来发第一条评论吧";
        }

        div.appendChild(span_1);
        div.appendChild(span_1_text);
        div.appendChild(span_2);
        div.appendChild(span_2_text);
        divWhole.appendChild(span);
        divWhole.appendChild(p);
        divWhole.appendChild(div);
        liSend.appendChild(left);
        liSend.appendChild(span_send);
        liSend.appendChild(right);
        liSend.appendChild(textarea);
        liSend.appendChild(icon);
        li.appendChild(divWhole);
        li.appendChild(ul);
        li.appendChild(liSend);

        return li;
    }

    function appendReview(targetUID, character, content, append) {
        var li = document.createElement("li");
        li.className = "hqhf zhongyang";

        var p = document.createElement("p");
        p.className = "hqhfnr";
        p.innerText = content;

        var span = document.createElement("span");
        span.className = "hqhfyuan";
        span.innerText = character;

        li.appendChild(span);
        li.appendChild(p);
        if (append) {
            var div = document.createElement("div");
            div.className = "hqxjpl";
            div.innerText = "+";
            div.onclick = function () {
                var tempLI = document.getElementById("piece " + targetUID).getElementsByTagName("li");
                for (var i = 0; i < tempLI.length; i++) {
                    if (tempLI[i].style.display == "none")
                        tempLI[i].style.display = "block";
                }
                div.style.display = "none";
            };
            li.appendChild(div);
        }

        return li
    }

    function hqxinjian(id, textarea) {
        if (document.getElementById(id).style.display == "none") {
            document.getElementById(id).style.display = "block";
            document.getElementById(textarea).focus();
        } else {
            document.getElementById(id).style.display = "none";
        }
    }

    function init() {
        postMessage({serverType: "Get", num: 20}, "conversation.php", function (json) {
            main.innerHTML = "";
            var black = false;
            for (var i = 0; i < json.length; i++) {
                main.appendChild(appendTopic(json[i].UID, json[i].word, json[i].content, json[i].good, json[i].review, black));
                black = !black;
            }
            main_2.innerHTML = "";
            var black = false;
            for (var i = 0; i < json.debunk.length; i++) {
                main.appendChild(appendTopic(json.debunk[i].UID, json.debunk[i].word, json.debunk[i].content, json.debunk[i].good, json.debunk[i].review, black));
                black = !black;
            }
            for (var i = 0; i < json.conversation.length; i++) {
                main_2.appendChild(appendConversation(json.conversation[i].content, json.conversation[i].good, i, json.conversation[i].UID));
                black = !black;
            }
        });
    }
</script>
</body>
</html>